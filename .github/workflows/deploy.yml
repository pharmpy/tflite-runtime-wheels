name: Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:


jobs:
  build-wheels:
    name: build-wheels
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        platform: [windows-latest]
        python-version: ['3.10']
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install python dependencies
      run: pip install numpy pybind11 wheel
    - name: Clone tensorflow 
      uses: actions/checkout@v2
      with:
        repository: tensorflow/tensorflow
        ref: refs/tags/v2.12.0
    - name: Build wheel
      run: |
        which bazel
        export PATH=/mingw64/bin:/usr/bin:/c/Users/runneradmin/bin:/c/Users/runneradmin/AppData/Roaming/Python/Python310/Scripts:/c/hostedtoolcache/windows/Python/3.10.11/x64/Scripts:/c/hostedtoolcache/windows/Python/3.10.11/x64:/bin:/c/Windows/system32:/c/Windows:/cmd:/mingw64/bin:/usr/bin
        echo $PATH
        . tensorflow/lite/tools/pip_package/build_pip_package_with_bazel.sh
      shell: bash
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: wheel-${{ matrix.platform }}-${{ matrix.python-version }}
        path: tensorflow/lite/tools/pip_package/gen/tflite_pip/python3/dist/*.whl

  upload-wheels:
    needs: build-wheels
    name: upload-wheels
    runs-on: ubuntu-latest
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v2
    - name: Prepare upload
      run: |
        mkdir upload
        find . -name '*.whl' | xargs cp -t upload/
        ls -lR
